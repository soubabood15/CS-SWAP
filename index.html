<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ูุธุงู ุชุจุฏูู ุงูุดูุชุงุช โ ุชุณุฌูู ุฏุฎูู</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial, sans-serif;max-width:980px;margin:20px auto;padding:18px;background:#f5f6f8;color:#111}
    h1{text-align:center;margin-bottom:14px}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:14px}
    label{display:block;margin:8px 0 6px}
    input,select,button{width:100%;padding:8px;border:1px solid #cfcfcf;border-radius:6px;font-size:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    button.primary{background:#2b7bd3;color:#fff;border:0}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{border:1px solid #e0e0e0;padding:8px;text-align:center}
    th{background:#fafafa}
    .small{font-size:13px;color:#666}
    .muted{color:#666}
    .notice{padding:8px;border-radius:6px;background:#fff7d6;color:#7a6000;margin-top:8px}
    .danger{background:#ffdcdc;color:#8b1f1f}
    .inline{display:inline-block;width:auto;padding:6px 10px;border-radius:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>๐ ูุธุงู ุชุจุฏูู ุงูุดูุชุงุช</h1>

  <!-- AUTH CARD -->
  <div class="card" id="authCard">
    <div id="authForms">
      <h3>ุชุณุฌูู / ุฏุฎูู</h3>

      <div id="signupBox">
        <label>ุฅูุดุงุก ุญุณุงุจ (ุฅูููู)</label>
        <input type="email" id="suEmail" placeholder="example@mail.com" />
        <label>ูููุฉ ุงููุฑูุฑ</label>
        <input type="password" id="suPass" placeholder="ูููุฉ ุงููุฑูุฑ" />
        <button id="btnSignup" class="primary">ุฅูุดุงุก ุญุณุงุจ</button>
      </div>

      <hr style="margin:12px 0" />

      <div id="signinBox">
        <label>ุชุณุฌูู ุฏุฎูู</label>
        <input type="email" id="siEmail" placeholder="example@mail.com" />
        <label>ูููุฉ ุงููุฑูุฑ</label>
        <input type="password" id="siPass" placeholder="ูููุฉ ุงููุฑูุฑ" />
        <button id="btnSignin" class="primary">ุชุณุฌูู ุฏุฎูู</button>
      </div>
    </div>

    <div id="userBox" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">ูุชุตู ูู:</div>
          <div id="userEmail" style="font-weight:600"></div>
        </div>
        <div style="text-align:right">
          <button id="btnSignout" class="inline">ุชุณุฌูู ุฎุฑูุฌ</button>
        </div>
      </div>
      <div id="userNotice" class="small muted" style="margin-top:8px">ุนูุฏู ุทูุจ ูุงุญุฏ ููุท. ููููู ุญุฐู ุทูุจู ูุฅุฑุณุงู ุทูุจ ุฌุฏูุฏ.</div>
    </div>
  </div>

  <!-- MAIN: form + tables -->
  <div id="mainArea" class="hidden">
    <!-- form -->
    <div class="card">
      <h3>ุฃุถู / ุญุฏูุซ ุทูุจ ุงูุดูุช (ูุณุชุฎุฏู ูุณุฌู)</h3>

      <label>๐ ููุงู ุงูุนูู</label>
      <select id="workLocation">
        <option value="ูู ุงูุจูุช">ูู ุงูุจูุช</option>
        <option value="ูู ุงูุดุฑูุฉ">ูู ุงูุดุฑูุฉ</option>
      </select>

      <label>๐ ุฑูู ุงููุงุชู (ุฃุฑูุงู ููุท)</label>
      <input id="phone" type="text" placeholder="ูุซุงู: 0551234567" />

      <label>โง ุงูุฌูุณ</label>
      <select id="gender">
        <option value="ุฐูุฑ">ุฐูุฑ</option>
        <option value="ุฃูุซู">ุฃูุซู</option>
      </select>

      <div class="row" style="margin-top:6px">
        <div>
          <label>ุงูุดูุช ุงูุญุงูู</label>
          <select id="currentShift">
            <option value="11-8">11-8</option>
            <option value="5-2">5-2</option>
          </select>
        </div>
        <div>
          <label>ุงูุดูุช ุงููุทููุจ</label>
          <select id="wantedShift">
            <option value="11-8">11-8</option>
            <option value="5-2">5-2</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnSubmit" class="primary">ุฅุฑุณุงู ุงูุทูุจ</button>
        <button id="btnDelete" class="inline danger hidden">ุญุฐู ุทูุจู</button>
      </div>

      <div id="formMessage" class="notice hidden"></div>
    </div>

    <!-- tables -->
    <div class="card">
      <h3>ุทูุจุงุช ุงูููุงู ุงูุญุงูู (ุณุชูุนุฑุถ ุญุณุจ ุงุฎุชูุงุฑู: ูู ุงูุจูุช / ูู ุงูุดุฑูุฉ)</h3>
      <div class="small">ูู ุชุฑู ุทูุจุงุช ููุงู ุขุฎุฑ โ ูุฐุง ูููุนู ูู ุฑุคูุฉ ุทูุจุงุช ุงูุดุฑูุฉ ุฅู ุงุฎุชุฑุช "ูู ุงูุจูุช" ูุงูุนูุณ.</div>
      <table>
        <thead>
          <tr><th>ููุงู ุงูุนูู</th><th>ุงููุงุชู</th><th>ุงูุฌูุณ</th><th>ุดูุช ุงูุญุงูู</th><th>ุดูุช ูุทููุจ</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>ุงูุทูุจุงุช ุงูุชู ููุง ุชุจุงุฏู ูุชุงุญ (ุถูู ููุณ ุงูููุงู)</h3>
      <table>
        <thead>
          <tr><th>ููุงู ุงูุนูู</th><th>ุงููุงุชู</th><th>ุงูุฌูุณ</th><th>ุดูุช ุงูุญุงูู</th><th>ุดูุช ูุทููุจ</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    // ุงุณุชูุฑุงุฏ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // ---- ุถุน ุฅุนุฏุงุฏุงุช Firebase ุงูุฎุงุตุฉ ุจูุดุฑูุนู ููุง ----
    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };
    // -----------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, 'requests');

    // DOM
    const authCard = document.getElementById('authCard');
    const authForms = document.getElementById('authForms');
    const signupBox = document.getElementById('signupBox');
    const signinBox = document.getElementById('signinBox');
    const btnSignup = document.getElementById('btnSignup');
    const btnSignin = document.getElementById('btnSignin');
    const suEmail = document.getElementById('suEmail');
    const suPass = document.getElementById('suPass');
    const siEmail = document.getElementById('siEmail');
    const siPass = document.getElementById('siPass');

    const userBox = document.getElementById('userBox');
    const userEmail = document.getElementById('userEmail');
    const btnSignout = document.getElementById('btnSignout');

    const mainArea = document.getElementById('mainArea');
    const workLocationEl = document.getElementById('workLocation');
    const phoneEl = document.getElementById('phone');
    const genderEl = document.getElementById('gender');
    const currentShiftEl = document.getElementById('currentShift');
    const wantedShiftEl = document.getElementById('wantedShift');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnDelete = document.getElementById('btnDelete');
    const formMessage = document.getElementById('formMessage');

    const requestsTable = document.getElementById('requestsTable');
    const matchesTable = document.getElementById('matchesTable');

    // ุญุงูุฉ ูุญููุฉ
    let allRequests = {}; // ูุงูู ุงูุจูุงูุงุช ูู Firebase (key -> item)
    let currentUser = null;
    let myRequestKey = null; // ููุชุงุญ ุทูุจ ุงููุณุชุฎุฏู ูู DB ูู ููุฌูุฏ

    // --- AUTH handlers ---
    btnSignup.addEventListener('click', async () => {
      const email = suEmail.value.trim();
      const pass = suPass.value;
      if (!email || !pass) return alert('ุงุฏุฎู ุฅูููู ููููุฉ ูุฑูุฑ.');
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        alert('ุชู ุฅูุดุงุก ุงูุญุณุงุจ. ููููู ุชุณุฌูู ุงูุฏุฎูู ุงูุขู.');
        suEmail.value = ''; suPass.value = '';
      } catch(err) {
        alert('ุฎุทุฃ ุฅูุดุงุก ุญุณุงุจ: ' + err.message);
      }
    });

    btnSignin.addEventListener('click', async () => {
      const email = siEmail.value.trim();
      const pass = siPass.value;
      if (!email || !pass) return alert('ุงุฏุฎู ุฅูููู ููููุฉ ูุฑูุฑ.');
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        siEmail.value = ''; siPass.value = '';
      } catch(err) {
        alert('ุฎุทุฃ ุชุณุฌูู ุงูุฏุฎูู: ' + err.message);
      }
    });

    btnSignout.addEventListener('click', async () => {
      await signOut(auth);
    });

    // --- React to auth state ---
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        // ุนุฑุถ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        authForms.classList.add('hidden');
        userBox.classList.remove('hidden');
        userEmail.textContent = user.email;
        mainArea.classList.remove('hidden');
        // ููุฑูุง ูุชุญูู ูู ุนูุฏู ุทูุจ ููุฌูุฏ
        findMyRequest();
      } else {
        // ุนุฑุถ ููุงุฐุฌ ุงูุชุณุฌูู/ุชุณุฌูู ุงูุฏุฎูู
        authForms.classList.remove('hidden');
        userBox.classList.add('hidden');
        mainArea.classList.add('hidden');
        userEmail.textContent = '';
        myRequestKey = null;
      }
    });

    // --- ุงูุงุณุชูุงุน ูุชุบูุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (Realtime) ---
    onValue(requestsRef, (snap) => {
      const val = snap.val() || {};
      allRequests = val; // ูุงุฆู {key: {workLocation, phone,...}}
      refreshUI();
    });

    // --- ุฏูุงู ูุณุงุนุฏุฉ ---
    function refreshUI(){
      // ูุนุฑุถ ุงูุทูุจุงุช ููููุงู ุงูุฐู ุงุฎุชุงุฑู ุงููุณุชุฎุฏู (ุฅุฐุง ูุณุฌู)
      const userLoc = workLocationEl.value;

      // ุฌุฏูู ูู ุงูุทูุจุงุช (ููุชุฑ ุจุงูููุงู)
      requestsTable.innerHTML = '';
      Object.entries(allRequests).forEach(([key, req]) => {
        if (!userLoc || req.workLocation !== userLoc) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(req.workLocation)}</td>
                        <td>${escapeHtml(req.phone)}</td>
                        <td>${escapeHtml(req.gender)}</td>
                        <td>${escapeHtml(req.currentShift)}</td>
                        <td>${escapeHtml(req.wantedShift)}</td>`;
        requestsTable.appendChild(tr);
      });

      // ุฌุฏูู ุงููุทุงุจูุงุช (ุถูู ููุณ ุงูููุงู)
      matchesTable.innerHTML = '';
      const seen = new Set();
      Object.entries(allRequests).forEach(([k1, r1]) => {
        if (!userLoc || r1.workLocation !== userLoc) return;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1) && !seen.has(match[0])) {
          // ุนุฑุถ ููุง ุงูุทุฑููู ูุตู ูุงุญุฏ (ูุฎุชุงุฑ ุนุฑุถ r1 ุฃููุงู)
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(r1.workLocation)}</td>
                          <td>${escapeHtml(r1.phone)} โ ${escapeHtml(match[1].phone)}</td>
                          <td>${escapeHtml(r1.gender)}</td>
                          <td>${escapeHtml(r1.currentShift)}</td>
                          <td>${escapeHtml(r1.wantedShift)}</td>`;
          matchesTable.appendChild(tr);
          seen.add(k1); seen.add(match[0]);
        }
      });

      // ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุงูุฎุงุต ุจุงููุณุชุฎุฏู (ูุฌูุฏ/ุนุฏู ูุฌูุฏ)
      if (currentUser) {
        // ูุจุญุซ ุนู ุทูุจ ุญูุซ userId === currentUser.uid
        myRequestKey = null;
        Object.entries(allRequests).forEach(([k, r]) => {
          if (r.userId === currentUser.uid) myRequestKey = k;
        });

        if (myRequestKey) {
          // ุนุทู ุงูุฅุฑุณุงูุ ูุฃุธูุฑ ุฒุฑ ุญุฐู ูุจูุงูุงุช ุงูุทูุจ
          btnSubmit.disabled = true;
          btnDelete.classList.remove('hidden');
          formMessage.classList.remove('hidden');
          const my = allRequests[myRequestKey];
          formMessage.innerHTML = `ูุฏูู ุทูุจ ููุนู:<br>
            <strong>ููุงู:</strong> ${escapeHtml(my.workLocation)} โ <strong>ูุงุชู:</strong> ${escapeHtml(my.phone)} โ <strong>ุดูุช:</strong> ${escapeHtml(my.currentShift)} โ ${escapeHtml(my.wantedShift)}`;
          // ุถุน ุงูููู ูู ุงูุญููู (ุงุฎุชูุงุฑู ููุนุฑุถ)
          phoneEl.value = my.phone;
          genderEl.value = my.gender;
          currentShiftEl.value = my.currentShift;
          wantedShiftEl.value = my.wantedShift;
          workLocationEl.value = my.workLocation;
        } else {
          btnSubmit.disabled = false;
          btnDelete.classList.add('hidden');
          formMessage.classList.add('hidden');
          phoneEl.value = '';
        }
      }
    }

    // ุชุญูู ุฅู ุฑูู ุงููุงุชู ุฌุฏูุฏ ูุบูุฑ ูุณุฌู (ููุน ุณุจุงู)
    function phoneExists(phone){
      return Object.values(allRequests).some(r => r.phone === phone);
    }

    // ุงูุจุญุซ ุนู ุทูุจ ุงููุณุชุฎุฏู (ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู)
    function findMyRequest(){
      if (!currentUser) return;
      myRequestKey = null;
      Object.entries(allRequests).forEach(([k, r]) => {
        if (r.userId === currentUser.uid) myRequestKey = k;
      });
      refreshUI();
    }

    // ุฅุฑุณุงู ุทูุจ ุฌุฏูุฏ (ูุฑุชุจุท ุจุงููุณุชุฎุฏู)
    btnSubmit.addEventListener('click', async () => {
      if (!currentUser) return alert('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.');
      const workLocation = workLocationEl.value;
      const phone = phoneEl.value.trim();
      const gender = genderEl.value;
      const currentShift = currentShiftEl.value;
      const wantedShift = wantedShiftEl.value;

      if (!/^[0-9]{9,12}$/.test(phone)) {
        alert('ุฑูู ุงููุงุชู ูุฌุจ ุฃู ูููู ุฃุฑูุงู ููุท ูุทููู ุจูู 9 ู12 ุฑูู.');
        return;
      }

      // ููุน ุชูุฑุงุฑ ุฑูู
      if (phoneExists(phone)) {
        alert('ูุฐุง ุงูุฑูู ูุณุฌู ุจุงููุนู. ูุง ููููู ุฅุถุงูุฉ ุฃูุซุฑ ูู ุทูุจ ุจููุณ ุฑูู ุงููุงุชู.');
        return;
      }

      // ููุน ุงููุณุชุฎุฏู ูู ุฅุถุงูุฉ ุฃูุซุฑ ูู ุทูุจ (ุชุญููู ุฅุถุงูู)
      if (Object.values(allRequests).some(r => r.userId === currentUser.uid)) {
        alert('ูุฏูู ุทูุจ ุญุงููุงู. ุงุญุฐู ุทูุจู ุฃููุง ุฅู ุฃุฑุฏุช ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ.');
        return;
      }

      // ุฅุถุงูุฉ ุงูุทูุจ ูุฑุชุจุท ุจุงูู userId + email
      try {
        await push(requestsRef, {
          userId: currentUser.uid,
          email: currentUser.email,
          workLocation, phone, gender, currentShift, wantedShift,
          createdAt: Date.now()
        });
        // ุณูุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ูู ุญุฏุซ onValue
      } catch(err) {
        alert('ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ: ' + err.message);
      }
    });

    // ุญุฐู ุทูุจ ุงููุณุชุฎุฏู (ุฅู ูุฌุฏ)
    btnDelete.addEventListener('click', async () => {
      if (!myRequestKey) return alert('ูุง ููุฌุฏ ุทูุจ ูุญุฐูู.');
      const sure = confirm('ูู ุชุฑูุฏ ุญุฐู ุทูุจู ููุงุฆูุงูุ');
      if (!sure) return;
      try {
        await remove(ref(db, 'requests/' + myRequestKey));
        myRequestKey = null;
        alert('ุชู ุญุฐู ุทูุจู.');
      } catch(err) {
        alert('ุฎุทุฃ ุนูุฏ ุงูุญุฐู: ' + err.message);
      }
    });

    // ูุณุงุนุฏุฉ: sanitize
    function escapeHtml(s){
      if (s == null) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // ูู ุงููุณุชุฎุฏู ุบููุฑ workLocation (ูุฑูุฏ ูุจุฏูู ุงูุนุฑุถ) ูุนูุฏ ุจูุงุก ุงููุงุฌูุฉ ููุฑูุงู
    workLocationEl.addEventListener('change', () => refreshUI());

  </script>
</body>
</html>
