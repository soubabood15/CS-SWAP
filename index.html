<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📅 نظام تبديل الشفتات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Tajawal',sans-serif;max-width:950px;margin:20px auto;padding:20px;background:#f0f2f5;color:#333}
    h1{text-align:center;margin-bottom:25px}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:20px;position:relative}
    label{display:block;margin:10px 0 5px;font-weight:600}
    input,select,button{width:100%;padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:6px;font-size:15px;transition:.2s}
    input:focus,select:focus{border-color:#2980B9;box-shadow:0 0 6px rgba(41,128,185,.3)}
    button{cursor:pointer;font-weight:600;position:relative}
    .primary{background:#2980B9;color:#fff;border:none}
    .primary:hover{background:#1f6390}
    .danger{background:#e74c3c;color:#fff;border:none}
    .danger:hover{background:#c0392b}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#f9fafc}
    .hidden{display:none}
    .notice{padding:10px;background:#fffbe6;border:1px solid #ffe58f;margin-top:12px;border-radius:6px}
    /* دوران الزر عند دومين غير صحيح */
    @keyframes rotate {
      0%{transform:rotate(0deg)}
      25%{transform:rotate(10deg)}
      50%{transform:rotate(-10deg)}
      75%{transform:rotate(10deg)}
      100%{transform:rotate(0deg)}
    }
    .rotate{animation:rotate .6s infinite;background:#e74c3c!important}
    /* رسالة خطأ تحت الخانات */
    .error{
      color:#e74c3c;font-weight:600;margin-top:4px;
      opacity:0;transform:translateY(-5px);transition:.35s ease
    }
    .error.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <h1>📅 نظام تبديل الشفتات</h1>

  <!-- ✅ صندوق تسجيل الدخول -->
  <div id="loginBox" class="card">
    <h3>🔑 تسجيل دخول</h3>
    <input type="email" id="email" placeholder="الإيميل (name@csmena.com)" />
    <input type="password" id="password" placeholder="كلمة المرور" />
    <button id="btnLogin" class="primary">دخول</button>
    <p id="loginError" class="error"></p>
  </div>

  <!-- ✅ منطقة النظام بعد الدخول -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3>👋 أهلاً <span id="userName"></span></h3>
        <button id="btnLogout" class="danger">🚪 تسجيل خروج</button>
      </div>

      <div id="myRequest" class="notice hidden"></div>

      <label>📍 مكان العمل</label>
      <select id="workLocation">
        <option value="من البيت">من البيت</option>
        <option value="من الشركة">من الشركة</option>
      </select>

      <label>📞 رقم الهاتف</label>
      <input type="text" id="phone" placeholder="مثال: 0551234567" />

      <label>⚧ الجنس</label>
      <select id="gender">
        <option value="ذكر">ذكر</option>
        <option value="أنثى">أنثى</option>
      </select>

      <label>شفتك الحالي</label>
      <select id="currentShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <label>الشفت المطلوب</label>
      <select id="wantedShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <button id="btnSubmit" class="primary">📩 إرسال الطلب</button>
      <button id="btnDelete" class="danger hidden">🗑️ حذف طلبي</button>
    </div>

    <div class="card">
      <h3>📋 طلبات مكانك</h3>
      <table>
        <thead>
          <tr><th>مكان</th><th>الهاتف</th><th>الجنس</th><th>شفت حالي</th><th>شفت مطلوب</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>🤝 الطلبات المتاحة للتبديل</h3>
      <table>
        <thead>
          <tr><th>مكان</th><th>الهاتف</th><th>الجنس</th><th>شفت حالي</th><th>شفت مطلوب</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- ✅ Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, "requests");

    // DOM
    const loginBox = document.getElementById("loginBox");
    const mainArea = document.getElementById("mainArea");
    const userNameSpan = document.getElementById("userName");
    const btnLogin = document.getElementById("btnLogin");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginError = document.getElementById("loginError");

    const phoneEl = document.getElementById("phone");
    const genderEl = document.getElementById("gender");
    const workLocationEl = document.getElementById("workLocation");
    const currentShiftEl = document.getElementById("currentShift");
    const wantedShiftEl = document.getElementById("wantedShift");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");
    const requestsTable = document.getElementById("requestsTable");
    const matchesTable = document.getElementById("matchesTable");
    const myRequestDiv = document.getElementById("myRequest");

    let allRequests = {};
    let myRequestKey = null;
    let wrongMode = false; // تفعيل زر الهروب عند كلمة سر خاطئة

    // 🔹 شرط الدومين (@csmena.com) → دوران الزر إن كان خاطئ
    emailEl.addEventListener("input", () => {
      loginError.classList.remove("show");
      if (!emailEl.value.toLowerCase().endsWith("@csmena.com")) {
        btnLogin.classList.add("rotate");
      } else {
        btnLogin.classList.remove("rotate");
      }
    });

    // 🔹 تسجيل الدخول
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value;

      loginError.classList.remove("show");
      // لو الدومين غير صحيح لا نحاول الدخول
      if (!email.toLowerCase().endsWith("@csmena.com")) return;

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // نجاح: نخفي صندوق الدخول ونظهر النظام فوراً (بدون Alerts)
        wrongMode = false;
        btnLogin.style.position = "relative";
        btnLogin.style.left = "0px";
        btnLogin.style.top = "0px";
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
      } catch (err) {
        // كلمة مرور/إيميل خاطئ
        wrongMode = true;
        btnLogin.style.position = "absolute"; // فعّل وضع الهروب
        loginError.textContent = "كلمة السر أو الإيميل خاطئ";
        loginError.classList.add("show");
      }
    });

    // 🔹 حركة زر الهروب عند مرور الماوس
    btnLogin.addEventListener("mouseover", () => {
      if (!wrongMode) return;
      // حركه عشوائية ضمن حدود البطاقة
      const x = Math.floor(Math.random() * 220) - 110; // يمين/يسار
      const y = Math.floor(Math.random() * 120) - 60;  // فوق/تحت
      btnLogin.style.left = x + "px";
      btnLogin.style.top = y + "px";
    });

    // 🔹 متابعة حالة الدخول الرسمية (تضمن التزامن دائمًا)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
        userNameSpan.textContent = user.displayName || user.email; // نعرض الاسم إن موجود
        refreshUI();
      } else {
        loginBox.classList.remove("hidden");
        mainArea.classList.add("hidden");
        myRequestKey = null;
        wrongMode = false;
        btnLogin.classList.remove("rotate");
        btnLogin.style.position = "relative";
        btnLogin.style.left = "0px";
        btnLogin.style.top = "0px";
        loginError.classList.remove("show");
      }
    });

    // 🔹 خروج
    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      // يرجع تلقائياً لصندوق الدخول عبر onAuthStateChanged
    });

    // 🔹 الاستماع لتغيرات الطلبات
    onValue(requestsRef, (snap) => {
      allRequests = snap.val() || {};
      refreshUI();
    });

    // 🔹 إرسال طلب
    btnSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      if (myRequestKey) return alert("عندك طلب موجود. احذفه لتضيف جديد.");

      const phone = phoneEl.value.trim();
      if (!/^[0-9]{9,12}$/.test(phone)) return alert("📞 رقم الهاتف غير صحيح (9-12 رقم).");

      // منع تكرار رقم الهاتف عبر أي مستخدم
      const phoneTaken = Object.values(allRequests).some(r => r.phone === phone);
      if (phoneTaken) return alert("⚠️ هذا الرقم مسجل مسبقاً.");

      await push(requestsRef, {
        userId: user.uid,
        email: user.email,
        workLocation: workLocationEl.value,
        phone,
        gender: genderEl.value,
        currentShift: currentShiftEl.value,
        wantedShift: wantedShiftEl.value,
        createdAt: Date.now()
      });
    });

    // 🔹 حذف الطلب
    btnDelete.addEventListener("click", async () => {
      if (!myRequestKey) return;
      await remove(ref(db, "requests/" + myRequestKey));
      myRequestKey = null;
    });

    // 🔹 تحديث الجداول وواجهة طلبي
    function refreshUI(){
      const user = auth.currentUser;
      if (!user) return;

      const userLoc = workLocationEl.value;
      requestsTable.innerHTML = "";
      matchesTable.innerHTML = "";

      // استخرج مفتاح طلبي (إن وجد)
      myRequestKey = null;
      Object.entries(allRequests).forEach(([key, r]) => {
        if (r.userId === user.uid) myRequestKey = key;
      });

      // جدول كل الطلبات لمكاني فقط
      Object.values(allRequests)
        .filter(r => r.workLocation === userLoc)
        .forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.workLocation}</td><td>${r.phone}</td><td>${r.gender}</td><td>${r.currentShift}</td><td>${r.wantedShift}</td>`;
          requestsTable.appendChild(tr);
        });

      // جدول المطابقات (ضمن نفس المكان)
      const seen = new Set();
      Object.entries(allRequests).forEach(([k1, r1]) => {
        if (r1.workLocation !== userLoc) return;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1) && !seen.has(match[0])) {
          seen.add(k1); seen.add(match[0]);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r1.workLocation}</td><td>${r1.phone} ⇄ ${match[1].phone}</td><td>${r1.gender}</td><td>${r1.currentShift}</td><td>${r1.wantedShift}</td>`;
          matchesTable.appendChild(tr);
        }
      });

      // حالة طلبي
      if (myRequestKey) {
        const my = allRequests[myRequestKey];
        myRequestDiv.classList.remove("hidden");
        myRequestDiv.innerHTML = `📌 طلبك الحالي: ${my.currentShift} ➝ ${my.wantedShift} (${my.phone})`;
        btnDelete.classList.remove("hidden");
        btnSubmit.disabled = true;
        // عبئ الحقول بقيم طلبي (اختياري)
        phoneEl.value = my.phone;
        genderEl.value = my.gender;
        workLocationEl.value = my.workLocation;
        currentShiftEl.value = my.currentShift;
        wantedShiftEl.value = my.wantedShift;
      } else {
        myRequestDiv.classList.add("hidden");
        btnDelete.classList.add("hidden");
        btnSubmit.disabled = false;
        phoneEl.value = "";
      }
    }

    // لو المستخدم غيّر مكان العمل، حدث الجداول
    workLocationEl.addEventListener("change", refreshUI);
  </script>
</body>
</html>
