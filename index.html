<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Tajawal',sans-serif;max-width:950px;margin:20px auto;padding:20px;background:#f0f2f5;color:#333}
    h1{text-align:center;margin-bottom:25px}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:20px;position:relative}
    label{display:block;margin:10px 0 5px;font-weight:600}
    input,select,button{width:100%;padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:6px;font-size:15px;transition:.2s}
    input:focus,select:focus{border-color:#2980B9;box-shadow:0 0 6px rgba(41,128,185,.3)}
    button{cursor:pointer;font-weight:600;position:relative}
    .primary{background:#2980B9;color:#fff;border:none}
    .primary:hover{background:#1f6390}
    .danger{background:#e74c3c;color:#fff;border:none}
    .danger:hover{background:#c0392b}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#f9fafc}
    .hidden{display:none}
    .notice{padding:10px;background:#fffbe6;border:1px solid #ffe58f;margin-top:12px;border-radius:6px}
    /* Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø¯ÙˆÙ…ÙŠÙ† ØºÙŠØ± ØµØ­ÙŠØ­ */
    @keyframes rotate {
      0%{transform:rotate(0deg)}
      25%{transform:rotate(10deg)}
      50%{transform:rotate(-10deg)}
      75%{transform:rotate(10deg)}
      100%{transform:rotate(0deg)}
    }
    .rotate{animation:rotate .6s infinite;background:#e74c3c!important}
    /* Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ØªØ­Øª Ø§Ù„Ø®Ø§Ù†Ø§Øª */
    .error{
      color:#e74c3c;font-weight:600;margin-top:4px;
      opacity:0;transform:translateY(-5px);transition:.35s ease
    }
    .error.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <h1>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</h1>

  <!-- âœ… ØµÙ†Ø¯ÙˆÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox" class="card">
    <h3>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (name@csmena.com)" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginError" class="error"></p>
  </div>

  <!-- âœ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ <span id="userName"></span></h3>
        <button id="btnLogout" class="danger">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>

      <div id="myRequest" class="notice hidden"></div>

      <label>ğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
      <select id="workLocation">
        <option value="Ù…Ù† Ø§Ù„Ø¨ÙŠØª">Ù…Ù† Ø§Ù„Ø¨ÙŠØª</option>
        <option value="Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©">Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©</option>
      </select>

      <label>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input type="text" id="phone" placeholder="Ù…Ø«Ø§Ù„: 0551234567" />

      <label>âš§ Ø§Ù„Ø¬Ù†Ø³</label>
      <select id="gender">
        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
      </select>

      <label>Ø´ÙØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
      <select id="currentShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <label>Ø§Ù„Ø´ÙØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
      <select id="wantedShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <button id="btnSubmit" class="primary">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="btnDelete" class="danger hidden">ğŸ—‘ï¸ Ø­Ø°Ù Ø·Ù„Ø¨ÙŠ</button>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØ§Ù†Ùƒ</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>ğŸ¤ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- âœ… Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, "requests");

    // DOM
    const loginBox = document.getElementById("loginBox");
    const mainArea = document.getElementById("mainArea");
    const userNameSpan = document.getElementById("userName");
    const btnLogin = document.getElementById("btnLogin");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginError = document.getElementById("loginError");

    const phoneEl = document.getElementById("phone");
    const genderEl = document.getElementById("gender");
    const workLocationEl = document.getElementById("workLocation");
    const currentShiftEl = document.getElementById("currentShift");
    const wantedShiftEl = document.getElementById("wantedShift");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");
    const requestsTable = document.getElementById("requestsTable");
    const matchesTable = document.getElementById("matchesTable");
    const myRequestDiv = document.getElementById("myRequest");

    let allRequests = {};
    let myRequestKey = null;
    let wrongMode = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù‡Ø±ÙˆØ¨ Ø¹Ù†Ø¯ ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø©

    // ğŸ”¹ Ø´Ø±Ø· Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† (@csmena.com) â†’ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø²Ø± Ø¥Ù† ÙƒØ§Ù† Ø®Ø§Ø·Ø¦
    emailEl.addEventListener("input", () => {
      loginError.classList.remove("show");
      if (!emailEl.value.toLowerCase().endsWith("@csmena.com")) {
        btnLogin.classList.add("rotate");
      } else {
        btnLogin.classList.remove("rotate");
      }
    });

    // ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value;

      loginError.classList.remove("show");
      // Ù„Ùˆ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      if (!email.toLowerCase().endsWith("@csmena.com")) return;

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // Ù†Ø¬Ø§Ø­: Ù†Ø®ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Alerts)
        wrongMode = false;
        btnLogin.style.position = "relative";
        btnLogin.style.left = "0px";
        btnLogin.style.top = "0px";
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
      } catch (err) {
        // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±/Ø¥ÙŠÙ…ÙŠÙ„ Ø®Ø§Ø·Ø¦
        wrongMode = true;
        btnLogin.style.position = "absolute"; // ÙØ¹Ù‘Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø±ÙˆØ¨
        loginError.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø®Ø§Ø·Ø¦";
        loginError.classList.add("show");
      }
    });

    // ğŸ”¹ Ø­Ø±ÙƒØ© Ø²Ø± Ø§Ù„Ù‡Ø±ÙˆØ¨ Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§ÙˆØ³
    btnLogin.addEventListener("mouseover", () => {
      if (!wrongMode) return;
      // Ø­Ø±ÙƒÙ‡ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¶Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      const x = Math.floor(Math.random() * 220) - 110; // ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±
      const y = Math.floor(Math.random() * 120) - 60;  // ÙÙˆÙ‚/ØªØ­Øª
      btnLogin.style.left = x + "px";
      btnLogin.style.top = y + "px";
    });

    // ğŸ”¹ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© (ØªØ¶Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¯Ø§Ø¦Ù…Ù‹Ø§)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
        userNameSpan.textContent = user.displayName || user.email; // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø¥Ù† Ù…ÙˆØ¬ÙˆØ¯
        refreshUI();
      } else {
        loginBox.classList.remove("hidden");
        mainArea.classList.add("hidden");
        myRequestKey = null;
        wrongMode = false;
        btnLogin.classList.remove("rotate");
        btnLogin.style.position = "relative";
        btnLogin.style.left = "0px";
        btnLogin.style.top = "0px";
        loginError.classList.remove("show");
      }
    });

    // ğŸ”¹ Ø®Ø±ÙˆØ¬
    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      // ÙŠØ±Ø¬Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± onAuthStateChanged
    });

    // ğŸ”¹ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    onValue(requestsRef, (snap) => {
      allRequests = snap.val() || {};
      refreshUI();
    });

    // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨
    btnSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      if (myRequestKey) return alert("Ø¹Ù†Ø¯Ùƒ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯. Ø§Ø­Ø°ÙÙ‡ Ù„ØªØ¶ÙŠÙ Ø¬Ø¯ÙŠØ¯.");

      const phone = phoneEl.value.trim();
      if (!/^[0-9]{9,12}$/.test(phone)) return alert("ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (9-12 Ø±Ù‚Ù…).");

      // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¹Ø¨Ø± Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…
      const phoneTaken = Object.values(allRequests).some(r => r.phone === phone);
      if (phoneTaken) return alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.");

      await push(requestsRef, {
        userId: user.uid,
        email: user.email,
        workLocation: workLocationEl.value,
        phone,
        gender: genderEl.value,
        currentShift: currentShiftEl.value,
        wantedShift: wantedShiftEl.value,
        createdAt: Date.now()
      });
    });

    // ğŸ”¹ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
    btnDelete.addEventListener("click", async () => {
      if (!myRequestKey) return;
      await remove(ref(db, "requests/" + myRequestKey));
      myRequestKey = null;
    });

    // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆÙˆØ§Ø¬Ù‡Ø© Ø·Ù„Ø¨ÙŠ
    function refreshUI(){
      const user = auth.currentUser;
      if (!user) return;

      const userLoc = workLocationEl.value;
      requestsTable.innerHTML = "";
      matchesTable.innerHTML = "";

      // Ø§Ø³ØªØ®Ø±Ø¬ Ù…ÙØªØ§Ø­ Ø·Ù„Ø¨ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)
      myRequestKey = null;
      Object.entries(allRequests).forEach(([key, r]) => {
        if (r.userId === user.uid) myRequestKey = key;
      });

      // Ø¬Ø¯ÙˆÙ„ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù…ÙƒØ§Ù†ÙŠ ÙÙ‚Ø·
      Object.values(allRequests)
        .filter(r => r.workLocation === userLoc)
        .forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.workLocation}</td><td>${r.phone}</td><td>${r.gender}</td><td>${r.currentShift}</td><td>${r.wantedShift}</td>`;
          requestsTable.appendChild(tr);
        });

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª (Ø¶Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†)
      const seen = new Set();
      Object.entries(allRequests).forEach(([k1, r1]) => {
        if (r1.workLocation !== userLoc) return;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1) && !seen.has(match[0])) {
          seen.add(k1); seen.add(match[0]);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r1.workLocation}</td><td>${r1.phone} â‡„ ${match[1].phone}</td><td>${r1.gender}</td><td>${r1.currentShift}</td><td>${r1.wantedShift}</td>`;
          matchesTable.appendChild(tr);
        }
      });

      // Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ÙŠ
      if (myRequestKey) {
        const my = allRequests[myRequestKey];
        myRequestDiv.classList.remove("hidden");
        myRequestDiv.innerHTML = `ğŸ“Œ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${my.currentShift} â ${my.wantedShift} (${my.phone})`;
        btnDelete.classList.remove("hidden");
        btnSubmit.disabled = true;
        // Ø¹Ø¨Ø¦ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù‚ÙŠÙ… Ø·Ù„Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        phoneEl.value = my.phone;
        genderEl.value = my.gender;
        workLocationEl.value = my.workLocation;
        currentShiftEl.value = my.currentShift;
        wantedShiftEl.value = my.wantedShift;
      } else {
        myRequestDiv.classList.add("hidden");
        btnDelete.classList.add("hidden");
        btnSubmit.disabled = false;
        phoneEl.value = "";
      }
    }

    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠÙ‘Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ØŒ Ø­Ø¯Ø« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    workLocationEl.addEventListener("change", refreshUI);
  </script>
</body>
</html>
