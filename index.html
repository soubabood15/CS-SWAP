<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background:#f5f5f5; }
    h1 { text-align: center; }
    .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { cursor: pointer; }
    button.primary { background:#2980B9; color:#fff; border: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background:#eee; }
    .hidden { display: none; }
    .notice { padding: 8px; background:#fff7d6; margin-top: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</h1>

  <!-- âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox" class="card">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
    <button id="btnLogout">Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- âœ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <h3>Ø£Ù‡Ù„Ø§Ù‹ <span id="userEmail"></span></h3>
      <div id="myRequest" class="notice hidden"></div>

      <label>ğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
      <select id="workLocation">
        <option value="Ù…Ù† Ø§Ù„Ø¨ÙŠØª">Ù…Ù† Ø§Ù„Ø¨ÙŠØª</option>
        <option value="Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©">Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©</option>
      </select>

      <label>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input type="text" id="phone" placeholder="Ù…Ø«Ø§Ù„: 0551234567" />

      <label>âš§ Ø§Ù„Ø¬Ù†Ø³</label>
      <select id="gender">
        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
      </select>

      <label>Ø´ÙØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
      <select id="currentShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <label>Ø§Ù„Ø´ÙØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
      <select id="wantedShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <button id="btnSubmit" class="primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="btnDelete" class="hidden">Ø­Ø°Ù Ø·Ù„Ø¨ÙŠ</button>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØ§Ù†Ùƒ</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>âœ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, "requests");

    const loginBox = document.getElementById("loginBox");
    const mainArea = document.getElementById("mainArea");
    const userEmailSpan = document.getElementById("userEmail");
    const myRequestDiv = document.getElementById("myRequest");

    const phoneEl = document.getElementById("phone");
    const genderEl = document.getElementById("gender");
    const workLocationEl = document.getElementById("workLocation");
    const currentShiftEl = document.getElementById("currentShift");
    const wantedShiftEl = document.getElementById("wantedShift");

    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");
    const requestsTable = document.getElementById("requestsTable");
    const matchesTable = document.getElementById("matchesTable");

    let allRequests = {};
    let myRequestKey = null;

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert("âŒ Ø®Ø·Ø£: " + err.message);
      }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
        userEmailSpan.textContent = user.email;
        findMyRequest();
      } else {
        loginBox.classList.remove("hidden");
        mainArea.classList.add("hidden");
        myRequestKey = null;
      }
    });

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
    onValue(requestsRef, (snap) => {
      allRequests = snap.val() || {};
      refreshUI();
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨
    btnSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");

      if (myRequestKey) return alert("Ø¹Ù†Ø¯Ùƒ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯. Ø§Ø­Ø°ÙÙ‡ Ù„ØªØ¶ÙŠÙ Ø¬Ø¯ÙŠØ¯.");

      const phone = phoneEl.value.trim();
      if (!/^[0-9]{9,12}$/.test(phone)) return alert("ğŸ“ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");

      await push(requestsRef, {
        userId: user.uid,
        email: user.email,
        workLocation: workLocationEl.value,
        phone,
        gender: genderEl.value,
        currentShift: currentShiftEl.value,
        wantedShift: wantedShiftEl.value,
        createdAt: Date.now()
      });
    });

    // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
    btnDelete.addEventListener("click", async () => {
      if (myRequestKey) {
        await remove(ref(db, "requests/" + myRequestKey));
        myRequestKey = null;
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    function refreshUI() {
      const user = auth.currentUser;
      if (!user) return;

      const userLoc = workLocationEl.value;
      requestsTable.innerHTML = "";
      matchesTable.innerHTML = "";

      myRequestKey = null;
      for (const [key, r] of Object.entries(allRequests)) {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„
        if (r.workLocation === userLoc) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.workLocation}</td><td>${r.phone}</td><td>${r.gender}</td><td>${r.currentShift}</td><td>${r.wantedShift}</td>`;
          requestsTable.appendChild(tr);
        }
        // Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
        if (r.userId === user.uid) myRequestKey = key;
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„
      const seen = new Set();
      for (const [k1, r1] of Object.entries(allRequests)) {
        if (r1.workLocation !== userLoc) continue;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1)) {
          seen.add(k1); seen.add(match[0]);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r1.workLocation}</td><td>${r1.phone} â‡„ ${match[1].phone}</td><td>${r1.gender}</td><td>${r1.currentShift}</td><td>${r1.wantedShift}</td>`;
          matchesTable.appendChild(tr);
        }
      }

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (myRequestKey) {
        const my = allRequests[myRequestKey];
        myRequestDiv.classList.remove("hidden");
        myRequestDiv.innerHTML = `ğŸ“Œ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${my.currentShift} â ${my.wantedShift} (${my.phone})`;
        btnDelete.classList.remove("hidden");
        btnSubmit.disabled = true;
      } else {
        myRequestDiv.classList.add("hidden");
        btnDelete.classList.add("hidden");
        btnSubmit.disabled = false;
      }
    }

    function findMyRequest() {
      refreshUI();
    }
  </script>
</body>
</html>
