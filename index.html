<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📅 نظام تبديل الشفتات</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background:#f5f5f5; }
    h1 { text-align: center; }
    .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { cursor: pointer; }
    button.primary { background:#2980B9; color:#fff; border: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background:#eee; }
    .hidden { display: none; }
    .notice { padding: 8px; background:#fff7d6; margin-top: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>📅 نظام تبديل الشفتات</h1>

  <!-- ✅ تسجيل دخول -->
  <div id="loginBox" class="card">
    <h3>تسجيل دخول</h3>
    <input type="email" id="email" placeholder="الإيميل" />
    <input type="password" id="password" placeholder="كلمة المرور" />
    <button id="btnLogin" class="primary">دخول</button>
    <button id="btnLogout">خروج</button>
  </div>

  <!-- ✅ منطقة المستخدم -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <h3>أهلاً <span id="userEmail"></span></h3>
      <div id="myRequest" class="notice hidden"></div>

      <label>📍 مكان العمل</label>
      <select id="workLocation">
        <option value="من البيت">من البيت</option>
        <option value="من الشركة">من الشركة</option>
      </select>

      <label>📞 رقم الهاتف</label>
      <input type="text" id="phone" placeholder="مثال: 0551234567" />

      <label>⚧ الجنس</label>
      <select id="gender">
        <option value="ذكر">ذكر</option>
        <option value="أنثى">أنثى</option>
      </select>

      <label>شفتك الحالي</label>
      <select id="currentShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <label>الشفت المطلوب</label>
      <select id="wantedShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <button id="btnSubmit" class="primary">إرسال الطلب</button>
      <button id="btnDelete" class="hidden">حذف طلبي</button>
    </div>

    <div class="card">
      <h3>📋 طلبات مكانك</h3>
      <table>
        <thead>
          <tr><th>مكان</th><th>الهاتف</th><th>الجنس</th><th>شفت حالي</th><th>شفت مطلوب</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>✅ الطلبات المتاحة للتبديل</h3>
      <table>
        <thead>
          <tr><th>مكان</th><th>الهاتف</th><th>الجنس</th><th>شفت حالي</th><th>شفت مطلوب</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, "requests");

    const loginBox = document.getElementById("loginBox");
    const mainArea = document.getElementById("mainArea");
    const userEmailSpan = document.getElementById("userEmail");
    const myRequestDiv = document.getElementById("myRequest");

    const phoneEl = document.getElementById("phone");
    const genderEl = document.getElementById("gender");
    const workLocationEl = document.getElementById("workLocation");
    const currentShiftEl = document.getElementById("currentShift");
    const wantedShiftEl = document.getElementById("wantedShift");

    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");
    const requestsTable = document.getElementById("requestsTable");
    const matchesTable = document.getElementById("matchesTable");

    let allRequests = {};
    let myRequestKey = null;

    // تسجيل الدخول
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert("❌ خطأ: " + err.message);
      }
    });

    // تسجيل الخروج
    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // متابعة حالة الدخول
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
        userEmailSpan.textContent = user.email;
        findMyRequest();
      } else {
        loginBox.classList.remove("hidden");
        mainArea.classList.add("hidden");
        myRequestKey = null;
      }
    });

    // الاستماع للتغييرات
    onValue(requestsRef, (snap) => {
      allRequests = snap.val() || {};
      refreshUI();
    });

    // إرسال طلب
    btnSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("سجل دخول أولاً");

      if (myRequestKey) return alert("عندك طلب موجود. احذفه لتضيف جديد.");

      const phone = phoneEl.value.trim();
      if (!/^[0-9]{9,12}$/.test(phone)) return alert("📞 رقم غير صحيح");

      await push(requestsRef, {
        userId: user.uid,
        email: user.email,
        workLocation: workLocationEl.value,
        phone,
        gender: genderEl.value,
        currentShift: currentShiftEl.value,
        wantedShift: wantedShiftEl.value,
        createdAt: Date.now()
      });
    });

    // حذف الطلب
    btnDelete.addEventListener("click", async () => {
      if (myRequestKey) {
        await remove(ref(db, "requests/" + myRequestKey));
        myRequestKey = null;
      }
    });

    // تحديث العرض
    function refreshUI() {
      const user = auth.currentUser;
      if (!user) return;

      const userLoc = workLocationEl.value;
      requestsTable.innerHTML = "";
      matchesTable.innerHTML = "";

      myRequestKey = null;
      for (const [key, r] of Object.entries(allRequests)) {
        // عرض الطلبات الخاصة بمكان العمل
        if (r.workLocation === userLoc) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.workLocation}</td><td>${r.phone}</td><td>${r.gender}</td><td>${r.currentShift}</td><td>${r.wantedShift}</td>`;
          requestsTable.appendChild(tr);
        }
        // طلب المستخدم نفسه
        if (r.userId === user.uid) myRequestKey = key;
      }

      // عرض الطلبات المتاحة للتبديل
      const seen = new Set();
      for (const [k1, r1] of Object.entries(allRequests)) {
        if (r1.workLocation !== userLoc) continue;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1)) {
          seen.add(k1); seen.add(match[0]);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r1.workLocation}</td><td>${r1.phone} ⇄ ${match[1].phone}</td><td>${r1.gender}</td><td>${r1.currentShift}</td><td>${r1.wantedShift}</td>`;
          matchesTable.appendChild(tr);
        }
      }

      // حالة الطلب الخاص بالمستخدم
      if (myRequestKey) {
        const my = allRequests[myRequestKey];
        myRequestDiv.classList.remove("hidden");
        myRequestDiv.innerHTML = `📌 طلبك الحالي: ${my.currentShift} ➝ ${my.wantedShift} (${my.phone})`;
        btnDelete.classList.remove("hidden");
        btnSubmit.disabled = true;
      } else {
        myRequestDiv.classList.add("hidden");
        btnDelete.classList.add("hidden");
        btnSubmit.disabled = false;
      }
    }

    function findMyRequest() {
      refreshUI();
    }
  </script>
</body>
</html>
