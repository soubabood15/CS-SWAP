<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      max-width: 950px;
      margin: 20px auto;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      animation: fadeIn 1s ease-in;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      margin-bottom: 20px;
      animation: fadeInUp 0.8s ease-in-out;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      transition: all 0.3s;
    }
    input:focus, select:focus {
      border-color: #2980B9;
      box-shadow: 0 0 6px rgba(41,128,185,0.3);
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button.primary {
      background: #2980B9;
      color: #fff;
      border: none;
      transition: all 0.3s;
    }
    button.primary:hover {
      background: #1f6390;
      transform: scale(1.02);
    }
    button.danger {
      background: #e74c3c;
      color: #fff;
      border: none;
    }
    button.danger:hover {
      background: #c0392b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
      animation: fadeIn 1s ease-in;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #f9fafc;
    }
    .hidden { display: none; }
    .notice {
      padding: 10px;
      background: #fffbe6;
      border: 1px solid #ffe58f;
      color: #7a6000;
      margin-top: 12px;
      border-radius: 6px;
      animation: fadeIn 0.5s ease-in;
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { transform: translateY(15px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>ğŸ“… Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</h1>

  <!-- âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox" class="card">
    <h3>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- âœ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ <span id="userEmail"></span></h3>
        <button id="btnLogout" class="danger">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
      <div id="myRequest" class="notice hidden"></div>

      <label>ğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
      <select id="workLocation">
        <option value="Ù…Ù† Ø§Ù„Ø¨ÙŠØª">Ù…Ù† Ø§Ù„Ø¨ÙŠØª</option>
        <option value="Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©">Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©</option>
      </select>

      <label>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input type="text" id="phone" placeholder="Ù…Ø«Ø§Ù„: 0551234567" />

      <label>âš§ Ø§Ù„Ø¬Ù†Ø³</label>
      <select id="gender">
        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
      </select>

      <label>Ø´ÙØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
      <select id="currentShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <label>Ø§Ù„Ø´ÙØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
      <select id="wantedShift">
        <option value="11-8">11-8</option>
        <option value="5-2">5-2</option>
      </select>

      <button id="btnSubmit" class="primary">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="btnDelete" class="danger hidden">ğŸ—‘ï¸ Ø­Ø°Ù Ø·Ù„Ø¨ÙŠ</button>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØ§Ù†Ùƒ</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>ğŸ¤ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„</h3>
      <table>
        <thead>
          <tr><th>Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø´ÙØª Ø­Ø§Ù„ÙŠ</th><th>Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨</th></tr>
        </thead>
        <tbody id="matchesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- âœ… Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_EMe5vTzJHdvxH8ooRYgLCQdWZFgvsgQ",
      authDomain: "swap-8005b.firebaseapp.com",
      databaseURL: "https://swap-8005b-default-rtdb.firebaseio.com",
      projectId: "swap-8005b",
      storageBucket: "swap-8005b.appspot.com",
      messagingSenderId: "464443469235",
      appId: "1:464443469235:web:4d7904eeb3952402342fc6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const requestsRef = ref(db, "requests");

    const loginBox = document.getElementById("loginBox");
    const mainArea = document.getElementById("mainArea");
    const userEmailSpan = document.getElementById("userEmail");
    const myRequestDiv = document.getElementById("myRequest");
    const phoneEl = document.getElementById("phone");
    const genderEl = document.getElementById("gender");
    const workLocationEl = document.getElementById("workLocation");
    const currentShiftEl = document.getElementById("currentShift");
    const wantedShiftEl = document.getElementById("wantedShift");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnDelete = document.getElementById("btnDelete");
    const requestsTable = document.getElementById("requestsTable");
    const matchesTable = document.getElementById("matchesTable");

    let allRequests = {};
    let myRequestKey = null;

    // Ø¯Ø®ÙˆÙ„
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert("âŒ Ø®Ø·Ø£: " + err.message);
      }
    });

    // Ø®Ø±ÙˆØ¬
    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBox.classList.add("hidden");
        mainArea.classList.remove("hidden");
        userEmailSpan.textContent = user.email;
        refreshUI();
      } else {
        loginBox.classList.remove("hidden");
        mainArea.classList.add("hidden");
        myRequestKey = null;
      }
    });

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
    onValue(requestsRef, (snap) => {
      allRequests = snap.val() || {};
      refreshUI();
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨
    btnSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      if (myRequestKey) return alert("Ø¹Ù†Ø¯Ùƒ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯. Ø§Ø­Ø°ÙÙ‡ Ù„ØªØ¶ÙŠÙ Ø¬Ø¯ÙŠØ¯.");
      const phone = phoneEl.value.trim();
      if (!/^[0-9]{9,12}$/.test(phone)) return alert("ğŸ“ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");

      await push(requestsRef, {
        userId: user.uid,
        email: user.email,
        workLocation: workLocationEl.value,
        phone,
        gender: genderEl.value,
        currentShift: currentShiftEl.value,
        wantedShift: wantedShiftEl.value,
        createdAt: Date.now()
      });
    });

    // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
    btnDelete.addEventListener("click", async () => {
      if (myRequestKey) {
        await remove(ref(db, "requests/" + myRequestKey));
        myRequestKey = null;
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    function refreshUI() {
      const user = auth.currentUser;
      if (!user) return;

      const userLoc = workLocationEl.value;
      requestsTable.innerHTML = "";
      matchesTable.innerHTML = "";

      myRequestKey = null;
      for (const [key, r] of Object.entries(allRequests)) {
        if (r.workLocation === userLoc) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.workLocation}</td><td>${r.phone}</td><td>${r.gender}</td><td>${r.currentShift}</td><td>${r.wantedShift}</td>`;
          requestsTable.appendChild(tr);
        }
        if (r.userId === user.uid) myRequestKey = key;
      }

      const seen = new Set();
      for (const [k1, r1] of Object.entries(allRequests)) {
        if (r1.workLocation !== userLoc) continue;
        const match = Object.entries(allRequests).find(([k2, r2]) =>
          k1 !== k2 &&
          r2.workLocation === r1.workLocation &&
          r2.currentShift === r1.wantedShift &&
          r2.wantedShift === r1.currentShift
        );
        if (match && !seen.has(k1)) {
          seen.add(k1); seen.add(match[0]);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r1.workLocation}</td><td>${r1.phone} â‡„ ${match[1].phone}</td><td>${r1.gender}</td><td>${r1.currentShift}</td><td>${r1.wantedShift}</td>`;
          matchesTable.appendChild(tr);
        }
      }

      if (myRequestKey) {
        const my = allRequests[myRequestKey];
        myRequestDiv.classList.remove("hidden");
        myRequestDiv.innerHTML = `ğŸ“Œ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${my.currentShift} â ${my.wantedShift} (${my.phone})`;
        btnDelete.classList.remove("hidden");
        btnSubmit.disabled = true;
      } else {
        myRequestDiv.classList.add("hidden");
        btnDelete.classList.add("hidden");
        btnSubmit.disabled = false;
      }
    }
  </script>
</body>
</html>
